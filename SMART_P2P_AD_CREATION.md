# Smart P2P Ad Creation System

## Overview

Интеллектуальная система создания P2P объявлений на продажу USDT на Bybit с автоматическим выбором методов оплаты.

## Основные возможности

### 1. Автоматические параметры
- **Всегда продажа USDT**: side = "1" 
- **Фиксированная сумма**: minAmount = maxAmount (передается в рублях)
- **Время оплаты**: всегда 15 минут
- **Количество USDT**: автоматический расчет = (сумма_руб / курс) + 5 USDT

### 2. Автоматический выбор метода оплаты
- **Чередование SBP/Tinkoff**: если есть объявление с SBP, создаст с Tinkoff и наоборот
- **Учет откликов**: если на объявление есть отклики (frozenQuantity > 0), можно использовать тот же метод снова
- **Блокировка дубликатов**: два активных объявления без откликов не могут иметь один метод оплаты

### 3. Умные ограничения
- Максимум 2 активных объявления
- Автоматическое получение актуального курса продажи
- Проверка баланса USDT на Funding аккаунте

## Использование

### Python скрипт напрямую

```python
import json
from scripts.bybit_smart_ad_creator import SmartAdCreator

# Инициализация
creator = SmartAdCreator(api_key="YOUR_KEY", api_secret="YOUR_SECRET")

# Создание объявления на продажу USDT
result = creator.create_smart_ad({
    "amount": "10000",  # Сумма транзакции в рублях
    "remark": "Быстрая продажа USDT"  # Опционально
})
```

### Через stdin/stdout интерфейс

```bash
echo '{
  "api_key": "YOUR_KEY",
  "api_secret": "YOUR_SECRET",
  "ad_params": {
    "amount": "10000"
  }
}' | python scripts/bybit_smart_ad_creator.py
```

### Интеграция с Rust

```rust
// Используйте существующий bybit_create_ad.py с параметром smart_mode
let params = json!({
    "api_key": api_key,
    "api_secret": api_secret,
    "ad_params": {
        "smart_mode": true,  // Включает умный режим
        "amount": "10000"    // Сумма в рублях
    }
});
```

## Логика работы

### 1. Анализ активных объявлений
```
Получаем список активных объявлений
↓
Для каждого объявления проверяем:
- Есть ли отклики (frozenQuantity > 0)
- Какой метод оплаты используется
↓
Формируем списки:
- blocked_payment_types: методы без откликов
- available_payment_types: методы с откликами
```

### 2. Выбор метода оплаты
```
Если есть SBP → выбираем Tinkoff
Если есть Tinkoff → выбираем SBP
Если оба заблокированы → выбираем Bank Transfer
```

### 3. Создание объявления
```
Получаем актуальный курс продажи
↓
Рассчитываем количество USDT = (сумма_руб / курс) + 5
↓
Создаем объявление на продажу с выбранным методом
```

## Примеры сценариев

### Сценарий 1: Создание объявления на 10000 RUB
- **Курс**: 90.26 RUB/USDT
- **Расчет**: 10000 / 90.26 + 5 = 115.79 USDT
- **Результат**: Объявление на продажу 115.79 USDT за 10000 RUB

### Сценарий 2: Выбор метода оплаты
- **Активно**: SBP с откликами
- **Результат**: Создаст объявление с Tinkoff

### Сценарий 3: Лимит объявлений
- **Активно**: SBP и Tinkoff без откликов
- **Результат**: Откажет в создании (лимит 2 объявления)

## Коды ошибок

- `912120022`: Цена вне допустимого диапазона
- `912120023`: Минимальная сумма больше общей суммы
- `912120024`: Недостаточно USDT на Funding аккаунте
- `912300013`: Метод оплаты не найден
- `912300015`: Ошибка в параметре минимальной суммы
- `-1`: Достигнут лимит объявлений или нет доступных методов

## Тестирование

```bash
# Тест сценариев
python test_p2p_scenarios.py

# Создание тестового объявления
python test_smart_ad_creator.py
```

## Формула расчета

```
Количество USDT = (Сумма в RUB / Курс продажи) + 5 USDT

Пример:
- Сумма: 10000 RUB
- Курс: 90.26 RUB/USDT
- Количество: 10000 / 90.26 + 5 = 115.79 USDT
```

## Требования

- Python 3.7+
- Библиотеки: requests, hmac, hashlib
- Bybit API ключи с разрешениями FiatP2P
- Настроенные методы оплаты в аккаунте (SBP, Tinkoff)
- Баланс USDT на Funding аккаунте >= рассчитанного количества